<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>myWeight</title>
  <style>
    :root {
      --bg: #f5f4ff;
      --ink: #1a1631;
      --muted: #6a5f88;
      --card: #ffffff;
      --accent: #ff5ea8;
      --accent-2: #7b4dff;
      --accent-3: #2d7bff;
      --line: #e3dbff;
      --shadow: 0 18px 40px rgba(60,30,120,0.12);
      --radius: 18px;
      --sky: #64c9ff;
      --purple: #7b4dff;
      --pink: #ff5ea8;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Fira Sans", "Segoe UI", system-ui, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(100,201,255,0.55) 0%, rgba(100,201,255,0) 60%),
        radial-gradient(1100px 600px at 110% 0%, rgba(255,94,168,0.45) 0%, rgba(255,94,168,0) 60%),
        radial-gradient(900px 500px at 50% 110%, rgba(123,77,255,0.35) 0%, rgba(123,77,255,0) 60%),
        linear-gradient(180deg, #f5f4ff 0%, #f7f4ff 60%, #f3f1ff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .app {
      max-width: 1180px;
      margin: 0 auto;
      display: grid;
      gap: 20px;
    }

    .device-shell {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .device {
      position: relative;
      width: 390px;
      height: 844px;
      border-radius: 42px;
      background: #0f0f10;
      padding: 12px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.35);
    }

    .device::before {
      content: "";
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 110px;
      height: 26px;
      background: #0f0f10;
      border-radius: 0 0 16px 16px;
      z-index: 2;
    }

    .device-screen {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 32px;
      overflow: auto;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(100,201,255,0.55) 0%, rgba(100,201,255,0) 60%),
        radial-gradient(1100px 600px at 110% 0%, rgba(255,94,168,0.45) 0%, rgba(255,94,168,0) 60%),
        radial-gradient(900px 500px at 50% 110%, rgba(123,77,255,0.35) 0%, rgba(123,77,255,0) 60%),
        linear-gradient(180deg, #f5f4ff 0%, #f7f4ff 60%, #f3f1ff 100%);
    }

    .device-screen .app {
      max-width: 100%;
      margin: 0;
      padding: 24px 16px 96px;
    }

    .device-screen h1 {
      font-size: clamp(22px, 6vw, 34px);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: clamp(28px, 4vw, 46px);
      margin: 0;
      letter-spacing: -0.02em;
      white-space: nowrap;
      text-align: center;
    }

    .subtitle {
      color: var(--muted);
      font-size: 15px;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(245,244,255,0.92));
      border: 1px solid rgba(100,201,255,0.25);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-5 { grid-column: span 5; }
    .col-6 { grid-column: span 6; }
    .col-7 { grid-column: span 7; }
    .col-12 { grid-column: span 12; }

    label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, select, button, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(123,77,255,0.25);
      background: linear-gradient(180deg, rgba(100,201,255,0.18), rgba(255,255,255,0.9));
      font-size: 15px;
      font-family: inherit;
    }

    textarea { resize: vertical; min-height: 80px; }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--sky);
      box-shadow: 0 0 0 3px rgba(100,201,255,0.25);
    }

    button {
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      border: none;
      font-weight: 600;
      transition: transform 0.12s ease, filter 0.12s ease;
    }

    button.secondary {
      background: linear-gradient(135deg, rgba(100,201,255,0.25), rgba(255,255,255,0.9));
      color: var(--accent-2);
      border: 1px solid rgba(123,77,255,0.35);
    }

    button.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px dashed rgba(100,201,255,0.5);
    }

    button:active { transform: scale(0.98); }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .stat {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      text-align: center;
    }

    .stat .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; }
    .stat .value { font-size: 22px; font-weight: 600; margin-top: 6px; }

    .chart-wrap {
      position: relative;
      padding: 12px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(45,123,255,0.18), rgba(255,94,168,0.12));
      border: 1px solid var(--line);
    }

    .chart {
      width: 100%;
      height: 320px;
      border-radius: 14px;
      background: #fff;
      display: block;
    }

    .legend {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }

    .swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead th {
      text-align: left;
      padding: 10px;
      color: var(--muted);
      font-weight: 600;
      border-bottom: 1px solid var(--line);
    }

    tbody td {
      padding: 10px;
      border-bottom: 1px dashed var(--line);
      vertical-align: middle;
    }

    .actions {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
    }

    .actions button {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 8px;
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon-btn {
      width: auto;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      background: #fff;
      color: var(--accent-3);
      border: 1px solid var(--line);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 10;
    }

    .modal {
      width: 100%;
      max-width: 340px;
      background: #fff;
      border-radius: 18px;
      border: 1px solid var(--line);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal.open {
      display: block;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .bottom-nav {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 5;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      padding: 10px 12px 14px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
    }

    .bottom-nav button {
      position: relative;
      width: 100%;
      padding: 8px 6px;
      border-radius: 12px;
      font-size: 11px;
      background: #fff;
      color: var(--muted);
      border: 1px solid var(--line);
    }

    .bottom-nav button .icon {
      display: block;
      width: 26px;
      height: 26px;
      margin: 0 auto;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.12));
    }

    .bottom-nav button.active {
      color: #fff;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }

    .bottom-nav svg {
      width: 26px;
      height: 26px;
      fill: currentColor;
      stroke: none;
    }

    .bottom-nav button::after {
      content: "";
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 6px;
      height: 3px;
      border-radius: 999px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .bottom-nav button.active::after {
      opacity: 1;
    }

    .nav-login { color: var(--sky); background: linear-gradient(135deg, rgba(100,201,255,0.25), rgba(255,255,255,0.9)); }
    .nav-login::after { background: linear-gradient(90deg, var(--sky), var(--purple)); }
    .nav-login.active { background: linear-gradient(135deg, var(--sky), var(--purple)); }

    .nav-entry { color: var(--pink); background: linear-gradient(135deg, rgba(255,94,168,0.22), rgba(255,255,255,0.9)); }
    .nav-entry::after { background: linear-gradient(90deg, var(--pink), var(--purple)); }
    .nav-entry.active { background: linear-gradient(135deg, var(--pink), var(--purple)); }

    .nav-chart { color: var(--purple); background: linear-gradient(135deg, rgba(123,77,255,0.22), rgba(255,255,255,0.9)); }
    .nav-chart::after { background: linear-gradient(90deg, var(--purple), var(--sky)); }
    .nav-chart.active { background: linear-gradient(135deg, var(--purple), var(--sky)); }

    .nav-history { color: #8a5cff; background: linear-gradient(135deg, rgba(138,92,255,0.22), rgba(255,255,255,0.9)); }
    .nav-history::after { background: linear-gradient(90deg, #8a5cff, var(--pink)); }
    .nav-history.active { background: linear-gradient(135deg, #8a5cff, var(--pink)); }

    .nav-settings { color: #5a5fdd; background: linear-gradient(135deg, rgba(90,95,221,0.22), rgba(255,255,255,0.9)); }
    .nav-settings::after { background: linear-gradient(90deg, #5a5fdd, var(--sky)); }
    .nav-settings.active { background: linear-gradient(135deg, #5a5fdd, var(--sky)); }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .login-mode .bottom-nav {
      display: none;
    }

    .login-mode .device-screen .app {
      padding-bottom: 32px;
      padding-top: 56px;
    }

    .login-mode header {
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .login-mode header > div {
      width: 100%;
    }

    .login-mode .subtitle {
      text-align: center;
    }

    .entry-mode header {
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .entry-mode header > div {
      width: 100%;
    }

    .entry-mode .subtitle {
      text-align: center;
    }

    .entry-mode #page-entry .card {
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
    }

    .entry-mode #page-entry {
      min-height: 520px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 20px;
    }

    .entry-mode header {
      display: none;
    }

    .entry-hero {
      text-align: center;
    }

    .entry-hero h1 {
      margin-bottom: 6px;
    }

    @media (max-width: 900px) {
      .col-3, .col-4, .col-5, .col-6, .col-7 { grid-column: span 12; }
      header { flex-direction: column; align-items: flex-start; }
      .chart { height: 280px; }
    }

    @media (max-width: 520px) {
      body { padding: 10px; }
      .device { width: 100%; height: 92vh; }
    }
  </style>
</head>
<body>
  <div class="device-shell login-mode">
    <div class="device">
      <div class="device-screen">
        <div class="app">
          <header>
            <div>
              <h1>myWeight</h1>
              <div class="subtitle">Private, offline-first tracker stored in your browser.</div>
            </div>
            <div class="header-actions">
              <div class="subtitle" id="storageStatus">Storage: Local browser</div>
            </div>
          </header>

          <section class="page active" id="page-login">
            <div class="card grid">
              <div class="col-12">
                <h2 style="margin:0 0 10px 0; font-size:20px;">Login</h2>
              </div>
              <div class="col-12">
                <label for="loginEmail">Email</label>
                <input id="loginEmail" type="email" placeholder="you@example.com" />
              </div>
              <div class="col-12">
                <label for="loginPass">Password</label>
                <input id="loginPass" type="password" placeholder="••••••••" />
              </div>
              <div class="col-12" style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="loginBtn">Sign In</button>
                <button class="secondary" id="signupBtn">Create Account</button>
                <button class="ghost" id="continueBtn">Continue</button>
              </div>
              <div class="col-12">
                <div class="note">This is a UI-only mock until we add Supabase auth.</div>
              </div>
            </div>
          </section>

          <section class="page" id="page-entry">
            <section class="card grid">
              <div class="col-12 entry-hero">
                <h1>myWeight</h1>
                <div class="subtitle">Private, offline-first tracker stored in your browser.</div>
                <div class="subtitle">Storage: Local browser</div>
              </div>
              <div class="col-6">
                <label for="date">Date</label>
                <input id="date" type="date" />
              </div>
              <div class="col-6">
                <label for="weight">Weight</label>
                <input id="weight" type="number" step="0.1" min="0" placeholder="e.g., 182.4" />
              </div>
              <div class="col-12">
                <label for="notes">Notes (optional)</label>
                <textarea id="notes" placeholder="Sleep, workout, sodium, stress, etc."></textarea>
              </div>
              <div class="col-12" style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="saveBtn">Save Entry</button>
                <button id="clearBtn" class="secondary">Clear Form</button>
                <button id="deleteBtn" class="ghost" style="display:none;">Delete Entry</button>
              </div>
            </section>
          </section>

          <section class="page" id="page-chart">
            <section class="card">
              <div class="stats" id="stats"></div>
            </section>

            <section class="card">
              <div class="chart-wrap">
                <canvas id="chart" class="chart"></canvas>
              </div>
              <div class="legend">
                <div><span class="swatch" style="background:#d76b2d"></span>Daily</div>
                <div><span class="swatch" style="background:#1f6e62"></span>7-day avg</div>
              </div>
            </section>
          </section>

          <section class="page" id="page-history">
            <section class="card">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Weight</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
            </section>
          </section>
        </div>
        <div class="bottom-nav">
          <button class="active nav-login" data-page="login" aria-label="Login">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 3a6 6 0 1 1-4.242 10.243l-3.57 3.57a1 1 0 0 0 1.414 1.414l3.57-3.57A6 6 0 0 1 12 3Zm0 2a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z"/>
              </svg>
            </span>
            <span class="sr-only">Login</span>
          </button>
          <button class="nav-entry" data-page="entry" aria-label="Add Entry">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 0 1 0 2h-6v6a1 1 0 0 1-2 0v-6H5a1 1 0 1 1 0-2h6V5Z"/>
              </svg>
            </span>
            <span class="sr-only">Add Entry</span>
          </button>
          <button class="nav-chart" data-page="chart" aria-label="Chart">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 19a1 1 0 0 1-1-1V6a1 1 0 0 1 2 0v11h15a1 1 0 1 1 0 2H4Zm3-5l3-3 3 3 5-6a1 1 0 1 1 1.6 1.2l-5.7 6.8a1 1 0 0 1-1.5.06l-3.4-3.4-2.3 2.3a1 1 0 0 1-1.4-1.4Z"/>
              </svg>
            </span>
            <span class="sr-only">Chart</span>
          </button>
          <button class="nav-history" data-page="history" aria-label="History">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 4h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Zm0 2v3h12V6H6Zm0 5v3h12v-3H6Zm0 5v2h12v-2H6Z"/>
              </svg>
            </span>
            <span class="sr-only">History</span>
          </button>
          <button class="nav-settings" data-page="settings" aria-label="Settings">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 8.5a3.5 3.5 0 1 1 0 7a3.5 3.5 0 0 1 0-7Zm8.94 3.06l-1.76-.28a7.94 7.94 0 0 0-.58-1.4l1.05-1.45a1 1 0 0 0-.1-1.29l-1.42-1.42a1 1 0 0 0-1.29-.1l-1.45 1.05c-.45-.25-.92-.45-1.4-.58l-.28-1.76A1 1 0 0 0 11.99 2h-1.98a1 1 0 0 0-.99.83l-.28 1.76c-.48.13-.95.33-1.4.58L5.89 4.12a1 1 0 0 0-1.29.1L3.18 5.64a1 1 0 0 0-.1 1.29l1.05 1.45c-.25.45-.45.92-.58 1.4l-1.76.28a1 1 0 0 0-.83.99v1.98a1 1 0 0 0 .83.99l1.76.28c.13.48.33.95.58 1.4l-1.05 1.45a1 1 0 0 0 .1 1.29l1.42 1.42a1 1 0 0 0 1.29.1l1.45-1.05c.45.25.92.45 1.4.58l.28 1.76a1 1 0 0 0 .99.83h1.98a1 1 0 0 0 .99-.83l.28-1.76c.48-.13.95-.33 1.4-.58l1.45 1.05a1 1 0 0 0 1.29-.1l1.42-1.42a1 1 0 0 0 .1-1.29l-1.05-1.45c.25-.45.45-.92.58-1.4l1.76-.28a1 1 0 0 0 .83-.99v-1.98a1 1 0 0 0-.83-.99Z"/>
              </svg>
            </span>
            <span class="sr-only">Settings</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <div class="modal-backdrop" id="settingsBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-header">
        <div id="settingsTitle" style="font-weight:600;">Settings</div>
        <button id="closeSettings" class="icon-btn">Close</button>
      </div>
      <div class="note" id="authStatus">Auth: Not connected</div>
      <button id="signOutBtn" class="ghost" style="margin:10px 0;">Sign Out</button>
      <label for="defaultUnit">Default Unit</label>
      <select id="defaultUnit">
        <option value="lb">lb</option>
        <option value="kg">kg</option>
      </select>
      <div class="note">Used for all entries, stats, and goals.</div>
      <div style="height:12px;"></div>
      <label for="goalWeight">Goal Weight</label>
      <input id="goalWeight" type="number" step="0.1" min="0" placeholder="e.g., 170" />
      <label for="goalDate" style="margin-top:10px;">Goal Date</label>
      <input id="goalDate" type="date" />
      <label for="goalWeeks" style="margin-top:10px;">Timeframe (weeks)</label>
      <input id="goalWeeks" type="number" min="1" step="1" placeholder="e.g., 12" />
      <div class="note">Days: <span id="goalDays">0 days</span></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="saveGoalBtn">Save Goal</button>
        <button id="clearGoalBtn" class="secondary">Clear Goal</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "weight-log-v1";
    const GOAL_KEY = "weight-goal-v1";
    const UNIT_KEY = "weight-unit-v1";

    const SUPABASE_URL = "";
    const SUPABASE_ANON_KEY = "";
    const supabaseClient = (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;
    let supabaseSession = null;

    const dateEl = document.getElementById("date");
    const weightEl = document.getElementById("weight");
    const notesEl = document.getElementById("notes");
    const tableBody = document.getElementById("tableBody");
    const statsEl = document.getElementById("stats");
    const chart = document.getElementById("chart");
    const ctx = chart.getContext("2d");
    const deleteBtn = document.getElementById("deleteBtn");
    const storageStatusEl = document.getElementById("storageStatus");
    const loginEmailEl = document.getElementById("loginEmail");
    const loginPassEl = document.getElementById("loginPass");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const continueBtn = document.getElementById("continueBtn");

    const defaultUnitEl = document.getElementById("defaultUnit");
    const closeSettingsBtn = document.getElementById("closeSettings");
    const settingsBackdrop = document.getElementById("settingsBackdrop");
    const authStatusEl = document.getElementById("authStatus");
    const signOutBtn = document.getElementById("signOutBtn");

    const goalWeightEl = document.getElementById("goalWeight");
    const goalDateEl = document.getElementById("goalDate");
    const goalWeeksEl = document.getElementById("goalWeeks");
    const goalDaysEl = document.getElementById("goalDays");

    const navButtons = Array.from(document.querySelectorAll(".bottom-nav button"));
    const pages = Array.from(document.querySelectorAll(".page"));
    let editingId = null;

    function todayISO() {
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
      return local.toISOString().slice(0, 10);
    }

    function isSupabaseReady() {
      return !!supabaseClient;
    }

    function isAuthed() {
      return !!(supabaseClient && supabaseSession && supabaseSession.user);
    }

    function loadEntriesLocal() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveEntriesLocal(entries) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    async function loadEntries() {
      if (isAuthed()) {
        const { data, error } = await supabaseClient
          .from("weight_entries")
          .select("id,date,weight,notes")
          .eq("user_id", supabaseSession.user.id)
          .order("date", { ascending: true });
        if (error) {
          console.error(error);
          return [];
        }
        return data || [];
      }
      return loadEntriesLocal();
    }

    async function saveEntryRemote(entry) {
      if (!isAuthed()) return;
      const payload = {
        id: entry.id || undefined,
        user_id: supabaseSession.user.id,
        date: entry.date,
        weight: entry.weight,
        notes: entry.notes || ""
      };
      const { error } = await supabaseClient
        .from("weight_entries")
        .upsert(payload, { onConflict: "user_id,date" });
      if (error) console.error(error);
    }

    async function deleteEntryRemote(entryId) {
      if (!isAuthed()) return;
      const { error } = await supabaseClient
        .from("weight_entries")
        .delete()
        .eq("user_id", supabaseSession.user.id)
        .eq("id", entryId);
      if (error) console.error(error);
    }

    function loadGoalLocal() {
      const raw = localStorage.getItem(GOAL_KEY);
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    async function loadGoal() {
      if (isAuthed()) {
        const { data, error } = await supabaseClient
          .from("weight_goals")
          .select("goal_weight,goal_date")
          .eq("user_id", supabaseSession.user.id)
          .maybeSingle();
        if (error) {
          console.error(error);
          return null;
        }
        if (!data) return null;
        return { weight: Number(data.goal_weight), date: data.goal_date || "" };
      }
      return loadGoalLocal();
    }

    async function saveGoal(goal) {
      if (isAuthed()) {
        if (!goal) {
          const { error } = await supabaseClient
            .from("weight_goals")
            .delete()
            .eq("user_id", supabaseSession.user.id);
          if (error) console.error(error);
          return;
        }
        const { error } = await supabaseClient
          .from("weight_goals")
          .upsert({
            user_id: supabaseSession.user.id,
            goal_weight: goal.weight,
            goal_date: goal.date || null
          });
        if (error) console.error(error);
        return;
      }
      if (!goal) {
        localStorage.removeItem(GOAL_KEY);
        return;
      }
      localStorage.setItem(GOAL_KEY, JSON.stringify(goal));
    }

    function loadUnitLocal() {
      return localStorage.getItem(UNIT_KEY) || "lb";
    }

    async function loadUnit() {
      if (isAuthed()) {
        const { data, error } = await supabaseClient
          .from("user_settings")
          .select("unit")
          .eq("user_id", supabaseSession.user.id)
          .maybeSingle();
        if (error) {
          console.error(error);
          return "lb";
        }
        return data?.unit || "lb";
      }
      return loadUnitLocal();
    }

    async function saveUnit(unit) {
      if (isAuthed()) {
        const { error } = await supabaseClient
          .from("user_settings")
          .upsert({ user_id: supabaseSession.user.id, unit });
        if (error) console.error(error);
        return;
      }
      localStorage.setItem(UNIT_KEY, unit);
    }

    function setAuthStatus() {
      if (!isSupabaseReady()) {
        authStatusEl.textContent = "Auth: Disabled (set Supabase keys)";
        if (storageStatusEl) storageStatusEl.textContent = "Storage: Local browser";
        return;
      }
      if (isAuthed()) {
        authStatusEl.textContent = `Auth: ${supabaseSession.user.email}`;
        if (storageStatusEl) storageStatusEl.textContent = "Storage: Supabase";
      } else {
        authStatusEl.textContent = "Auth: Signed out";
        if (storageStatusEl) storageStatusEl.textContent = "Storage: Local browser";
      }
    }

    async function initSupabase() {
      if (!isSupabaseReady()) {
        setAuthStatus();
        return;
      }
      const { data } = await supabaseClient.auth.getSession();
      supabaseSession = data.session;
      setAuthStatus();
      supabaseClient.auth.onAuthStateChange((_event, session) => {
        supabaseSession = session;
        setAuthStatus();
        refreshFromAuth();
      });
    }

    async function refreshFromAuth() {
      defaultUnitEl.value = await loadUnit();
      const existingGoal = await loadGoal();
      syncGoalInputs(existingGoal);
      updateGoalDays();
      renderSafe();
    }

    async function signIn() {
      if (!isSupabaseReady()) {
        alert("Set SUPABASE_URL and SUPABASE_ANON_KEY in the code first.");
        return;
      }
      const email = loginEmailEl.value.trim();
      const password = loginPassEl.value;
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        alert(error.message);
        return;
      }
      switchPage("entry");
    }

    async function signUp() {
      if (!isSupabaseReady()) {
        alert("Set SUPABASE_URL and SUPABASE_ANON_KEY in the code first.");
        return;
      }
      const email = loginEmailEl.value.trim();
      const password = loginPassEl.value;
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if (error) {
        alert(error.message);
        return;
      }
      if (!data.session) {
        alert("Check your email to confirm your account.");
      }
      switchPage("entry");
    }

    async function signOut() {
      if (!isSupabaseReady()) return;
      await supabaseClient.auth.signOut();
      switchPage("login");
    }

    function sortEntries(entries) {
      return entries.slice().sort((a, b) => b.date.localeCompare(a.date));
    }

    function formatWeight(weight, unit) {
      return `${weight.toFixed(1)} ${unit}`;
    }

    function parseDateISO(value) {
      const date = new Date(value + "T00:00:00");
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function formatDateDisplay(value) {
      const d = parseDateISO(value);
      if (!d) return value;
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    function daysBetween(a, b) {
      const ms = b.getTime() - a.getTime();
      return Math.round(ms / 86400000);
    }

    function renderTable(entries, unit) {
      tableBody.innerHTML = "";
      for (const entry of entries) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatDateDisplay(entry.date)}</td>
          <td>${formatWeight(entry.weight, unit)}</td>
          <td class="actions">
            <button data-action="edit" data-id="${entry.id}" class="secondary">Edit</button>
          </td>
        `;
        tableBody.appendChild(tr);
      }
    }

    function renderStats(entries, goal, unit) {
      if (entries.length === 0) {
        statsEl.innerHTML = "<div class=\"stat\"><div class=\"label\">No data yet</div><div class=\"value\">Add an entry</div></div>";
        return;
      }

      const sorted = entries.slice().sort((a, b) => a.date.localeCompare(b.date));
      const first = sorted[0];
      const latest = sorted[sorted.length - 1];

      const lastSeven = sorted.slice(-7);
      const avg7 = lastSeven.reduce((sum, e) => sum + e.weight, 0) / lastSeven.length;
      const change = latest.weight - first.weight;

      const stats = [
        { label: "Latest", value: formatWeight(latest.weight, unit) },
        { label: "7-day avg", value: formatWeight(avg7, unit) },
        { label: "Change since start", value: `${change >= 0 ? "+" : ""}${change.toFixed(1)} ${unit}` }
      ];

      if (goal) {
        const goalWeight = goal.weight;
        const deltaTotal = goalWeight - first.weight;
        const deltaDone = latest.weight - first.weight;
        const progress = deltaTotal === 0 ? 1 : Math.min(1, Math.max(0, deltaDone / deltaTotal));

        const goalDate = parseDateISO(goal.date);
        let paceText = "";
        if (goalDate) {
          const latestDate = parseDateISO(latest.date) || new Date();
          const remainingDays = daysBetween(latestDate, goalDate);
          if (remainingDays > 0) {
            const remaining = goalWeight - latest.weight;
            const perWeek = remaining / (remainingDays / 7);
            paceText = `${perWeek >= 0 ? "+" : ""}${perWeek.toFixed(1)} ${unit}/week`;
          } else {
            paceText = "Goal date passed";
          }
        }

        stats.push(
          { label: "Goal", value: formatWeight(goalWeight, unit) },
          { label: "Progress", value: `${Math.round(progress * 100)}%` },
          { label: "Required pace", value: paceText || "Set a goal date" }
        );
      }

      statsEl.innerHTML = "";
      for (const s of stats) {
        const div = document.createElement("div");
        div.className = "stat";
        div.innerHTML = `<div class="label">${s.label}</div><div class="value">${s.value}</div>`;
        statsEl.appendChild(div);
      }
    }

    function resizeCanvas() {
      const rect = chart.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      chart.width = rect.width * dpr;
      chart.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function computeAvgSeries(values) {
      const avg = [];
      for (let i = 0; i < values.length; i++) {
        const start = Math.max(0, i - 6);
        const slice = values.slice(start, i + 1);
        const a = slice.reduce((sum, v) => sum + v, 0) / slice.length;
        avg.push(a);
      }
      return avg;
    }

    function drawChart(entries, unit) {
      const rect = chart.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      ctx.clearRect(0, 0, width, height);

      if (entries.length < 2) {
        ctx.fillStyle = "#7a6d5f";
        ctx.font = "14px Space Grotesk, Fira Sans, sans-serif";
        ctx.fillText("Add at least two entries to see the trend.", 16, 28);
        return;
      }

      const sorted = entries.slice().sort((a, b) => a.date.localeCompare(b.date));

      const points = sorted.map(e => {
        const date = parseDateISO(e.date);
        return { date, value: e.weight };
      }).filter(p => p.date);

      if (points.length < 2) return;

      const minDate = points[0].date;
      const maxDate = points[points.length - 1].date;

      const padding = 36;
      const spanMs = Math.max(1, maxDate.getTime() - minDate.getTime());

      const values = points.map(p => p.value);
      const avgValues = computeAvgSeries(values);
      const minVal = Math.min(...values, ...avgValues);
      const maxVal = Math.max(...values, ...avgValues);
      const valSpan = maxVal - minVal || 1;

      function xFor(date) {
        return padding + ((date.getTime() - minDate.getTime()) / spanMs) * (width - padding * 2);
      }

      function yFor(value) {
        return height - padding - ((value - minVal) / valSpan) * (height - padding * 2);
      }

      ctx.strokeStyle = "#e7d7c7";
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let i = 0; i <= 4; i++) {
        const y = padding + i * ((height - padding * 2) / 4);
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
      }
      ctx.stroke();

      const areaGradient = ctx.createLinearGradient(0, padding, 0, height - padding);
      areaGradient.addColorStop(0, "rgba(215,107,45,0.35)");
      areaGradient.addColorStop(1, "rgba(215,107,45,0.02)");

      ctx.beginPath();
      points.forEach((p, i) => {
        const x = xFor(p.date);
        const y = yFor(p.value);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.lineTo(xFor(points[points.length - 1].date), height - padding);
      ctx.lineTo(xFor(points[0].date), height - padding);
      ctx.closePath();
      ctx.fillStyle = areaGradient;
      ctx.fill();

      ctx.strokeStyle = "#d76b2d";
      ctx.lineWidth = 3;
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = xFor(p.date);
        const y = yFor(p.value);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.strokeStyle = "#1f6e62";
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      avgValues.forEach((v, i) => {
        const x = xFor(points[i].date);
        const y = yFor(v);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.fillStyle = "#5a5148";
      ctx.font = "12px Space Grotesk, Fira Sans, sans-serif";
      ctx.fillText(`${minVal.toFixed(1)} ${unit}`, padding, height - padding + 16);
      ctx.fillText(`${maxVal.toFixed(1)} ${unit}`, padding, padding - 10);
    }

    async function render() {
      const unit = defaultUnitEl.value || "lb";
      const entries = sortEntries(await loadEntries());
      const goal = await loadGoal();
      renderTable(entries, unit);
      renderStats(entries, goal, unit);
      drawChart(entries, unit);
    }

    function renderSafe() {
      render().catch(err => console.error(err));
    }

    function clearForm() {
      weightEl.value = "";
      notesEl.value = "";
      dateEl.value = todayISO();
      editingId = null;
      deleteBtn.style.display = "none";
    }

    async function addEntry() {
      const date = dateEl.value || todayISO();
      const weight = parseFloat(weightEl.value);
      if (!date || Number.isNaN(weight)) {
        alert("Please enter a date and weight.");
        return;
      }

      const entries = await loadEntries();
      const existingByDate = entries.find(e => e.date === date);
      if (editingId) {
        const current = entries.find(e => e.id === editingId);
        if (!current) {
          editingId = null;
        } else {
          if (existingByDate && existingByDate.id !== editingId) {
            if (!confirm("Another entry exists for that date. Replace it?")) return;
            const filtered = entries.filter(e => e.id !== existingByDate.id);
            const target = filtered.find(e => e.id === editingId);
            if (target) {
              target.date = date;
              target.weight = weight;
              target.notes = notesEl.value.trim();
            }
            if (isAuthed()) {
              await deleteEntryRemote(existingByDate.id);
              await saveEntryRemote(target);
            } else {
              saveEntriesLocal(filtered);
            }
            renderSafe();
            clearForm();
            return;
          }
          current.date = date;
          current.weight = weight;
          current.notes = notesEl.value.trim();
          if (isAuthed()) {
            await saveEntryRemote(current);
          } else {
            saveEntriesLocal(entries);
          }
          renderSafe();
          clearForm();
          return;
        }
      }

      if (existingByDate) {
        if (!confirm("An entry exists for that date. Replace it?")) return;
        existingByDate.weight = weight;
        existingByDate.notes = notesEl.value.trim();
      } else {
        entries.push({
          id: crypto.randomUUID(),
          date,
          weight,
          notes: notesEl.value.trim()
        });
      }

      if (isAuthed()) {
        const target = existingByDate || entries[entries.length - 1];
        await saveEntryRemote(target);
      } else {
        saveEntriesLocal(entries);
      }
      renderSafe();
      clearForm();
    }

    async function handleTableClick(e) {
      const button = e.target.closest("button");
      if (!button) return;
      const id = button.getAttribute("data-id");
      const action = button.getAttribute("data-action");
      const entries = await loadEntries();
      const entry = entries.find(x => x.id === id);
      if (!entry) return;

      if (action === "edit") {
        switchPage("entry");
        dateEl.value = entry.date;
        weightEl.value = entry.weight;
        notesEl.value = entry.notes;
        editingId = entry.id;
        deleteBtn.style.display = "inline-block";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    }

    async function deleteEntry() {
      if (!editingId) return;
      if (!confirm("Delete this entry?")) return;
      if (isAuthed()) {
        await deleteEntryRemote(editingId);
      } else {
        const entries = (await loadEntries()).filter(e => e.id !== editingId);
        saveEntriesLocal(entries);
      }
      renderSafe();
      clearForm();
    }


    function syncGoalInputs(goal) {
      if (!goal) {
        goalWeightEl.value = "";
        goalDateEl.value = "";
        goalWeeksEl.value = "";
        if (goalDaysEl) goalDaysEl.textContent = "0 days";
        return;
      }
      goalWeightEl.value = goal.weight;
      goalDateEl.value = goal.date || "";
      if (goal.date) {
        const weeks = Math.max(1, Math.round(daysBetween(new Date(), parseDateISO(goal.date)) / 7));
        goalWeeksEl.value = weeks;
      }
      updateGoalDays();
    }

    async function saveGoalFromInputs() {
      const weight = parseFloat(goalWeightEl.value);
      const date = goalDateEl.value;
      if (Number.isNaN(weight) || !date) {
        alert("Please enter a goal weight and date (or weeks). ");
        return;
      }
      const goal = { weight, date };
      await saveGoal(goal);
      renderSafe();
    }

    async function clearGoal() {
      await saveGoal(null);
      syncGoalInputs(null);
      renderSafe();
    }

    function updateGoalDateFromWeeks() {
      const weeks = parseInt(goalWeeksEl.value, 10);
      if (!weeks || weeks < 1) return;
      const start = new Date();
      start.setDate(start.getDate() + weeks * 7);
      const local = new Date(start.getTime() - start.getTimezoneOffset() * 60000);
      goalDateEl.value = local.toISOString().slice(0, 10);
      updateGoalDays();
    }

    function updateWeeksFromGoalDate() {
      if (!goalDateEl.value) return;
      const goalDate = parseDateISO(goalDateEl.value);
      if (!goalDate) return;
      const weeks = Math.max(1, Math.round(daysBetween(new Date(), goalDate) / 7));
      goalWeeksEl.value = weeks;
      updateGoalDays();
    }

    function updateGoalDays() {
      if (!goalDaysEl) return;
      let days = 0;
      if (goalDateEl.value) {
        const goalDate = parseDateISO(goalDateEl.value);
        if (goalDate) {
          days = Math.max(0, daysBetween(new Date(), goalDate));
        }
      } else if (goalWeeksEl.value) {
        const weeks = parseInt(goalWeeksEl.value, 10);
        if (weeks && weeks > 0) days = weeks * 7;
      }
      goalDaysEl.textContent = `${days} days`;
    }

    async function handleUnitChange() {
      const unit = defaultUnitEl.value;
      await saveUnit(unit);
      renderSafe();
    }

    function openSettings() {
      settingsBackdrop.classList.add("open");
      settingsBackdrop.setAttribute("aria-hidden", "false");
    }

    function closeSettings() {
      settingsBackdrop.classList.remove("open");
      settingsBackdrop.setAttribute("aria-hidden", "true");
    }

    function switchPage(page) {
      pages.forEach(p => p.classList.toggle("active", p.id === `page-${page}`));
      navButtons.forEach(b => b.classList.toggle("active", b.dataset.page === page));
      const shell = document.querySelector(".device-shell");
      shell.classList.toggle("login-mode", page === "login");
      shell.classList.toggle("entry-mode", page === "entry");
      if (page === "chart") {
        resizeCanvas();
        renderSafe();
      }
    }

    window.addEventListener("resize", () => {
      resizeCanvas();
      renderSafe();
    });

    document.getElementById("saveBtn").addEventListener("click", addEntry);
    document.getElementById("clearBtn").addEventListener("click", clearForm);
    deleteBtn.addEventListener("click", deleteEntry);

    document.getElementById("saveGoalBtn").addEventListener("click", saveGoalFromInputs);
    document.getElementById("clearGoalBtn").addEventListener("click", clearGoal);
    goalWeeksEl.addEventListener("change", updateGoalDateFromWeeks);
    goalDateEl.addEventListener("change", updateWeeksFromGoalDate);

    tableBody.addEventListener("click", handleTableClick);
    defaultUnitEl.addEventListener("change", handleUnitChange);
    closeSettingsBtn.addEventListener("click", closeSettings);
    settingsBackdrop.addEventListener("click", (e) => {
      if (e.target === settingsBackdrop) closeSettings();
    });

    navButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const page = btn.dataset.page;
        if (page === "settings") {
          openSettings();
          return;
        }
        switchPage(page);
      });
    });

    loginBtn.addEventListener("click", signIn);
    signupBtn.addEventListener("click", signUp);
    signOutBtn.addEventListener("click", signOut);
    continueBtn.addEventListener("click", () => switchPage("entry"));

    async function initApp() {
      dateEl.value = todayISO();
      await initSupabase();
      defaultUnitEl.value = await loadUnit();
      const existingGoal = await loadGoal();
      syncGoalInputs(existingGoal);
      updateGoalDays();
      resizeCanvas();
      renderSafe();
    }

    initApp().catch(err => console.error(err));
  </script>
</body>
</html>
