<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>myWeight</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7b4dff" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="myWeight" />
  <style>
    :root {
      --bg: #f5f4ff;
      --ink: #1a1631;
      --muted: #6a5f88;
      --card: #ffffff;
      --accent: #ff5ea8;
      --accent-2: #7b4dff;
      --accent-3: #2d7bff;
      --line: #e3dbff;
      --shadow: 0 18px 40px rgba(60,30,120,0.12);
      --radius: 18px;
      --sky: #64c9ff;
      --purple: #7b4dff;
      --pink: #ff5ea8;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Fira Sans", "Segoe UI", system-ui, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(100,201,255,0.55) 0%, rgba(100,201,255,0) 60%),
        radial-gradient(1100px 600px at 110% 0%, rgba(255,94,168,0.45) 0%, rgba(255,94,168,0) 60%),
        radial-gradient(900px 500px at 50% 110%, rgba(123,77,255,0.35) 0%, rgba(123,77,255,0) 60%),
        linear-gradient(180deg, #f5f4ff 0%, #f7f4ff 60%, #f3f1ff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .app {
      max-width: 1180px;
      margin: 0 auto;
      display: grid;
      gap: 20px;
    }

    .device-shell {
      width: 100%;
    }

    .device-screen {
      position: relative;
      width: 100%;
      min-height: 100vh;
      overflow: auto;
    }

    .device-screen .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 16px 96px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: clamp(28px, 4vw, 46px);
      margin: 0;
      letter-spacing: -0.02em;
      white-space: nowrap;
      text-align: center;
    }

    .subtitle {
      color: var(--muted);
      font-size: 15px;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(245,244,255,0.92));
      border: 1px solid rgba(100,201,255,0.25);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-5 { grid-column: span 5; }
    .col-6 { grid-column: span 6; }
    .col-7 { grid-column: span 7; }
    .col-12 { grid-column: span 12; }

    label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, select, button, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(123,77,255,0.25);
      background: linear-gradient(180deg, rgba(100,201,255,0.18), rgba(255,255,255,0.9));
      font-size: 15px;
      font-family: inherit;
    }

    textarea { resize: vertical; min-height: 80px; }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--sky);
      box-shadow: 0 0 0 3px rgba(100,201,255,0.25);
    }

    button {
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      border: none;
      font-weight: 600;
      transition: transform 0.12s ease, filter 0.12s ease;
    }

    button.secondary {
      background: linear-gradient(135deg, rgba(100,201,255,0.25), rgba(255,255,255,0.9));
      color: var(--accent-2);
      border: 1px solid rgba(123,77,255,0.35);
    }

    button.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px dashed rgba(100,201,255,0.5);
    }

    button:active { transform: scale(0.98); }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .stat {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      text-align: center;
    }

    .stat .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; }
    .stat .value { font-size: 22px; font-weight: 600; margin-top: 6px; }

    .chart-wrap {
      position: relative;
      padding: 12px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(45,123,255,0.18), rgba(255,94,168,0.12));
      border: 1px solid var(--line);
    }

    .chart {
      width: 100%;
      height: 320px;
      border-radius: 14px;
      background: #fff;
      display: block;
    }

    .legend {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }

    .swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead th {
      text-align: left;
      padding: 10px;
      color: var(--muted);
      font-weight: 600;
      border-bottom: 1px solid var(--line);
    }

    tbody td {
      padding: 10px;
      border-bottom: 1px dashed var(--line);
      vertical-align: middle;
    }

    .actions {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
    }

    .actions button {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 8px;
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon-btn {
      width: auto;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      background: #fff;
      color: var(--accent-3);
      border: 1px solid var(--line);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 10;
    }

    .modal {
      width: 100%;
      max-width: 340px;
      max-height: 90vh;
      overflow-y: auto;
      background: #fff;
      border-radius: 18px;
      border: 1px solid var(--line);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal.open {
      display: block;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 5;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      padding: 10px 12px 14px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
    }

    .bottom-nav button {
      position: relative;
      width: 100%;
      padding: 8px 6px;
      border-radius: 12px;
      font-size: 11px;
      background: #fff;
      color: var(--muted);
      border: 1px solid var(--line);
    }

    .bottom-nav button .icon {
      display: block;
      width: 26px;
      height: 26px;
      margin: 0 auto;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.12));
    }

    .bottom-nav button.active {
      color: #fff;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }

    .bottom-nav svg {
      width: 26px;
      height: 26px;
      fill: currentColor;
      stroke: none;
    }

    .bottom-nav button::after {
      content: "";
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 6px;
      height: 3px;
      border-radius: 999px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .bottom-nav button.active::after {
      opacity: 1;
    }

    .nav-login { color: var(--sky); background: linear-gradient(135deg, rgba(100,201,255,0.25), rgba(255,255,255,0.9)); }
    .nav-login::after { background: linear-gradient(90deg, var(--sky), var(--purple)); }
    .nav-login.active { background: linear-gradient(135deg, var(--sky), var(--purple)); }

    .nav-entry { color: var(--pink); background: linear-gradient(135deg, rgba(255,94,168,0.22), rgba(255,255,255,0.9)); }
    .nav-entry::after { background: linear-gradient(90deg, var(--pink), var(--purple)); }
    .nav-entry.active { background: linear-gradient(135deg, var(--pink), var(--purple)); }

    .nav-chart { color: var(--purple); background: linear-gradient(135deg, rgba(123,77,255,0.22), rgba(255,255,255,0.9)); }
    .nav-chart::after { background: linear-gradient(90deg, var(--purple), var(--sky)); }
    .nav-chart.active { background: linear-gradient(135deg, var(--purple), var(--sky)); }

    .nav-history { color: #8a5cff; background: linear-gradient(135deg, rgba(138,92,255,0.22), rgba(255,255,255,0.9)); }
    .nav-history::after { background: linear-gradient(90deg, #8a5cff, var(--pink)); }
    .nav-history.active { background: linear-gradient(135deg, #8a5cff, var(--pink)); }

    .nav-settings { color: #5a5fdd; background: linear-gradient(135deg, rgba(90,95,221,0.22), rgba(255,255,255,0.9)); }
    .nav-settings::after { background: linear-gradient(90deg, #5a5fdd, var(--sky)); }
    .nav-settings.active { background: linear-gradient(135deg, #5a5fdd, var(--sky)); }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .splash {
      position: fixed;
      inset: 0;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(100,201,255,0.65) 0%, rgba(100,201,255,0) 60%),
        radial-gradient(1100px 600px at 110% 0%, rgba(255,94,168,0.55) 0%, rgba(255,94,168,0) 60%),
        radial-gradient(900px 500px at 50% 110%, rgba(123,77,255,0.45) 0%, rgba(123,77,255,0) 60%),
        linear-gradient(180deg, #f5f4ff 0%, #f7f4ff 60%, #f3f1ff 100%);
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    .splash.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .splash-card {
      padding: 24px 28px;
      border-radius: 22px;
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(123,77,255,0.25);
      box-shadow: 0 18px 40px rgba(60,30,120,0.18);
      text-align: center;
      backdrop-filter: blur(8px);
    }

    .splash-logo {
      width: 84px;
      height: 84px;
      border-radius: 22px;
      margin: 0 auto 12px;
      background: linear-gradient(135deg, var(--sky), var(--purple), var(--pink));
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: -0.02em;
      box-shadow: 0 12px 24px rgba(0,0,0,0.2);
    }

    .splash-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 6px 0;
    }

    .splash-sub {
      color: var(--muted);
      font-size: 12px;
      margin: 0;
    }

    .login-mode .bottom-nav {
      display: none;
    }

    .login-mode .device-screen .app {
      padding-bottom: 32px;
      padding-top: 56px;
    }

    .login-mode header {
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .login-mode header > div {
      width: 100%;
    }

    .login-mode .subtitle {
      text-align: center;
    }

    .entry-mode header {
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .entry-mode header > div {
      width: 100%;
    }

    .entry-mode .subtitle {
      text-align: center;
    }

    .entry-mode #page-entry .card {
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
    }

    .entry-mode #page-entry {
      min-height: 520px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 20px;
    }

    .entry-mode header {
      display: none;
    }

    .entry-hero {
      text-align: center;
    }

    .entry-hero h1 {
      margin-bottom: 6px;
    }

    @media (max-width: 900px) {
      .col-3, .col-4, .col-5, .col-6, .col-7 { grid-column: span 12; }
      header { flex-direction: column; align-items: flex-start; }
      .chart { height: 280px; }
    }

    @media (max-width: 520px) {
      body { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="splash" id="splash">
    <div class="splash-card">
      <div class="splash-logo">myW</div>
      <h2 class="splash-title">myWeight</h2>
      <p class="splash-sub">Daily weight tracking</p>
    </div>
  </div>
  <div class="device-shell login-mode">
    <div class="device-screen">
      <div class="app">
          <header>
            <div>
              <h1>myWeight</h1>
            </div>
            <div class="header-actions">
              <div class="subtitle" id="storageStatus"></div>
            </div>
          </header>

          <section class="page active" id="page-login">
            <div class="card grid">
              <div class="col-12">
                <h2 style="margin:0 0 10px 0; font-size:20px;">Login</h2>
              </div>
              <div class="col-12">
                <div id="authMessage" class="note" style="min-height:18px;"></div>
              </div>
              <div class="col-12">
                <label for="loginEmail">Email</label>
                <input id="loginEmail" type="email" placeholder="you@example.com" />
              </div>
              <div class="col-12" id="passwordField">
                <label for="loginPass">Password</label>
                <input id="loginPass" type="password" placeholder="••••••••" />
              </div>
              <div class="col-12" style="display:flex; align-items:center; gap:8px;">
                <input id="useMagicLink" type="checkbox" style="width:auto;" />
                <label for="useMagicLink" style="margin:0; text-transform:none; letter-spacing:0;">Use magic link instead of password</label>
              </div>
              <div class="col-12" style="display:flex; align-items:center; gap:8px;">
                <input id="keepSignedIn" type="checkbox" style="width:auto;" />
                <label for="keepSignedIn" style="margin:0; text-transform:none; letter-spacing:0;">Keep me signed in</label>
              </div>
              <div class="col-12" style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="loginBtn">Sign In</button>
                <button class="secondary" id="signupBtn">Create Account</button>
                <button class="ghost" id="magicLinkBtn">Send Magic Link</button>
                <button class="ghost" id="resetPassBtn">Reset Password</button>
              </div>
            </div>
          </section>

          <section class="page" id="page-entry">
            <section class="card grid">
              <div class="col-12 entry-hero">
                <h1>myWeight</h1>
              </div>
              <div class="col-6">
                <label for="date">Date</label>
                <input id="date" type="date" />
              </div>
              <div class="col-6">
                <label for="weight">Weight</label>
                <input id="weight" type="number" step="0.1" min="0" placeholder="e.g., 182.4" />
              </div>
              <div class="col-12">
                <label for="notes">Notes (optional)</label>
                <textarea id="notes" placeholder="Sleep, workout, sodium, stress, etc."></textarea>
              </div>
              <div class="col-12" style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="saveBtn">Save Entry</button>
                <button id="clearBtn" class="secondary">Clear Form</button>
                <button id="deleteBtn" class="ghost" style="display:none;">Delete Entry</button>
              </div>
              <div class="col-12">
                <div id="entryMessage" class="note" style="min-height:18px;"></div>
              </div>
            </section>
          </section>

          <section class="page" id="page-chart">
            <section class="card">
              <div class="stats" id="stats"></div>
            </section>

            <section class="card" style="margin-bottom:8px;">
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <div>
                  <label for="chartFrom">From</label>
                  <input id="chartFrom" type="date" />
                </div>
                <div>
                  <label for="chartTo">To</label>
                  <input id="chartTo" type="date" />
                </div>
                <button id="chartRangeBtn" class="secondary" style="padding:10px 14px;">Apply</button>
                <button id="chartResetBtn" class="ghost" style="padding:10px 14px;">All</button>
              </div>
            </section>

            <section class="card">
              <div class="chart-wrap">
                <canvas id="chart" class="chart"></canvas>
              </div>
              <div class="legend">
                <div><span class="swatch" style="background:#2d7bff"></span>Daily</div>
                <div><span class="swatch" style="background:#7b4dff"></span>7-day avg</div>
                <div><span class="swatch" style="background:#ff5ea8; border-radius:0; height:2px; width:12px; margin-top:4px;"></span>Goal</div>
              </div>
            </section>
          </section>

          <section class="page" id="page-history">
            <section class="card">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Weight</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
            </section>
          </section>
      </div>
      <div class="bottom-nav">
          <button class="active nav-login" data-page="login" aria-label="Login">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 3a6 6 0 1 1-4.242 10.243l-3.57 3.57a1 1 0 0 0 1.414 1.414l3.57-3.57A6 6 0 0 1 12 3Zm0 2a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z"/>
              </svg>
            </span>
            <span class="sr-only">Login</span>
          </button>
          <button class="nav-entry" data-page="entry" aria-label="Add Entry">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 0 1 0 2h-6v6a1 1 0 0 1-2 0v-6H5a1 1 0 1 1 0-2h6V5Z"/>
              </svg>
            </span>
            <span class="sr-only">Add Entry</span>
          </button>
          <button class="nav-chart" data-page="chart" aria-label="Chart">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 19a1 1 0 0 1-1-1V6a1 1 0 0 1 2 0v11h15a1 1 0 1 1 0 2H4Zm3-5l3-3 3 3 5-6a1 1 0 1 1 1.6 1.2l-5.7 6.8a1 1 0 0 1-1.5.06l-3.4-3.4-2.3 2.3a1 1 0 0 1-1.4-1.4Z"/>
              </svg>
            </span>
            <span class="sr-only">Chart</span>
          </button>
          <button class="nav-history" data-page="history" aria-label="History">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 4h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Zm0 2v3h12V6H6Zm0 5v3h12v-3H6Zm0 5v2h12v-2H6Z"/>
              </svg>
            </span>
            <span class="sr-only">History</span>
          </button>
          <button class="nav-settings" data-page="settings" aria-label="Settings">
            <span class="icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 8.5a3.5 3.5 0 1 1 0 7a3.5 3.5 0 0 1 0-7Zm8.94 3.06l-1.76-.28a7.94 7.94 0 0 0-.58-1.4l1.05-1.45a1 1 0 0 0-.1-1.29l-1.42-1.42a1 1 0 0 0-1.29-.1l-1.45 1.05c-.45-.25-.92-.45-1.4-.58l-.28-1.76A1 1 0 0 0 11.99 2h-1.98a1 1 0 0 0-.99.83l-.28 1.76c-.48.13-.95.33-1.4.58L5.89 4.12a1 1 0 0 0-1.29.1L3.18 5.64a1 1 0 0 0-.1 1.29l1.05 1.45c-.25.45-.45.92-.58 1.4l-1.76.28a1 1 0 0 0-.83.99v1.98a1 1 0 0 0 .83.99l1.76.28c.13.48.33.95.58 1.4l-1.05 1.45a1 1 0 0 0 .1 1.29l1.42 1.42a1 1 0 0 0 1.29.1l1.45-1.05c.45.25.92.45 1.4.58l.28 1.76a1 1 0 0 0 .99.83h1.98a1 1 0 0 0 .99-.83l.28-1.76c.48-.13.95-.33 1.4-.58l1.45 1.05a1 1 0 0 0 1.29-.1l1.42-1.42a1 1 0 0 0 .1-1.29l-1.05-1.45c.25-.45.45-.92.58-1.4l1.76-.28a1 1 0 0 0 .83-.99v-1.98a1 1 0 0 0-.83-.99Z"/>
              </svg>
            </span>
            <span class="sr-only">Settings</span>
          </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <div class="modal-backdrop" id="settingsBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-header">
        <div id="settingsTitle" style="font-weight:600;">Settings</div>
        <button id="closeSettings" class="icon-btn">Close</button>
      </div>
      <div class="note" id="authStatus">Auth: Not connected</div>
      <button id="signOutBtn" class="ghost" style="margin:10px 0;">Log Out</button>
      <label for="defaultUnit">Default Unit</label>
      <select id="defaultUnit">
        <option value="lb">lb</option>
        <option value="kg">kg</option>
      </select>
      <div class="note">Used for all entries, stats, and goals.</div>
      <div style="height:12px;"></div>
      <label for="profileName">Name</label>
      <input id="profileName" type="text" placeholder="Your name" />
      <label for="profileTimezone" style="margin-top:10px;">Timezone</label>
      <input id="profileTimezone" type="text" placeholder="e.g., Australia/Sydney" />
      <label for="profileHeight" style="margin-top:10px;">Height in cm (optional)</label>
      <input id="profileHeight" type="number" step="0.1" min="0" placeholder="e.g., 175" />
      <div style="height:12px;"></div>
      <label for="goalWeight">Goal Weight</label>
      <input id="goalWeight" type="number" step="0.1" min="0" placeholder="e.g., 170" />
      <label for="goalDate" style="margin-top:10px;">Goal Date</label>
      <input id="goalDate" type="date" />
      <label for="goalWeeks" style="margin-top:10px;">Timeframe (weeks)</label>
      <input id="goalWeeks" type="number" min="1" step="1" placeholder="e.g., 12" />
      <div class="note">Days: <span id="goalDays">0 days</span></div>
      <div style="height:12px;"></div>
      <label for="chartMin">Chart Min (kg)</label>
      <input id="chartMin" type="number" step="0.1" min="0" placeholder="e.g., 90.0" />
      <label for="chartMax" style="margin-top:10px;">Chart Max (kg)</label>
      <input id="chartMax" type="number" step="0.1" min="0" placeholder="e.g., 105.0" />
      <label for="chartStep" style="margin-top:10px;">Y Axis Interval (kg)</label>
      <input id="chartStep" type="number" step="0.1" min="0.1" placeholder="e.g., 0.25" />
      <div id="settingsMessage" class="note" style="min-height:18px;"></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="saveSettingsBtn">Save Settings</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "weight-log-v1";
    const GOAL_KEY = "weight-goal-v1";
    const UNIT_KEY = "weight-unit-v1";

    const SUPABASE_URL = "https://axcrgtcqtfygoxheqqhb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4Y3JndGNxdGZ5Z294aGVxcWhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NzA0NjMsImV4cCI6MjA4NjA0NjQ2M30.CdaYOJdXrXevtOrvlvUKhXLY9jecbPE2yudIBwRoPN8";
    const AUTH_PERSIST_KEY = "auth_persist";
    let supabaseClient = null;
    let supabaseSession = null;

    const dateEl = document.getElementById("date");
    const weightEl = document.getElementById("weight");
    const notesEl = document.getElementById("notes");
    const tableBody = document.getElementById("tableBody");
    const statsEl = document.getElementById("stats");
    const chart = document.getElementById("chart");
    const ctx = chart.getContext("2d");
    const deleteBtn = document.getElementById("deleteBtn");
    const storageStatusEl = document.getElementById("storageStatus");
    const loginEmailEl = document.getElementById("loginEmail");
    const loginPassEl = document.getElementById("loginPass");
    const useMagicLinkEl = document.getElementById("useMagicLink");
    const keepSignedInEl = document.getElementById("keepSignedIn");
    const passwordFieldEl = document.getElementById("passwordField");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const magicLinkBtn = document.getElementById("magicLinkBtn");
    const resetPassBtn = document.getElementById("resetPassBtn");
    const authMessageEl = document.getElementById("authMessage");

    const defaultUnitEl = document.getElementById("defaultUnit");
    const closeSettingsBtn = document.getElementById("closeSettings");
    const settingsBackdrop = document.getElementById("settingsBackdrop");
    const authStatusEl = document.getElementById("authStatus");
    const signOutBtn = document.getElementById("signOutBtn");
    const profileNameEl = document.getElementById("profileName");
    const profileTimezoneEl = document.getElementById("profileTimezone");
    const profileHeightEl = document.getElementById("profileHeight");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");
    const chartMinEl = document.getElementById("chartMin");
    const chartMaxEl = document.getElementById("chartMax");
    const chartStepEl = document.getElementById("chartStep");

    const goalWeightEl = document.getElementById("goalWeight");
    const goalDateEl = document.getElementById("goalDate");
    const goalWeeksEl = document.getElementById("goalWeeks");
    const goalDaysEl = document.getElementById("goalDays");
    const settingsMessageEl = document.getElementById("settingsMessage");
    const entryMessageEl = document.getElementById("entryMessage");

    const chartFromEl = document.getElementById("chartFrom");
    const chartToEl = document.getElementById("chartTo");
    const chartRangeBtn = document.getElementById("chartRangeBtn");
    const chartResetBtn = document.getElementById("chartResetBtn");

    const navButtons = Array.from(document.querySelectorAll(".bottom-nav button"));
    const pages = Array.from(document.querySelectorAll(".page"));
    let editingId = null;
    let chartDateFrom = "";
    let chartDateTo = "";
    const splashEl = document.getElementById("splash");

    function todayISO() {
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
      return local.toISOString().slice(0, 10);
    }

    function isSupabaseReady() {
      return !!supabaseClient;
    }

    function getAuthPersist() {
      const stored = localStorage.getItem(AUTH_PERSIST_KEY);
      if (stored === null) return true;
      return stored === "true";
    }

    function setAuthPersist(value) {
      localStorage.setItem(AUTH_PERSIST_KEY, value ? "true" : "false");
    }

    function createSupabaseClient() {
      if (!(SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase)) return null;
      const persist = getAuthPersist();
      const storage = persist ? window.localStorage : window.sessionStorage;
      return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          storage,
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });
    }

    function isAuthed() {
      return !!(supabaseClient && supabaseSession && supabaseSession.user);
    }

    function loadEntriesLocal() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveEntriesLocal(entries) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    async function loadEntries() {
      if (isAuthed()) {
        const { data, error } = await supabaseClient
          .from("weight_entries")
          .select("id,date,weight,notes")
          .eq("user_id", supabaseSession.user.id)
          .order("date", { ascending: true });
        if (error) {
          console.error(error);
          return loadEntriesLocal();
        }
        return (data || []).map(row => ({
          ...row,
          weight: Number(row.weight)
        }));
      }
      return loadEntriesLocal();
    }

    async function saveEntryRemote(entry) {
      if (!isAuthed()) return;
      const payload = {
        id: entry.id || undefined,
        user_id: supabaseSession.user.id,
        date: entry.date,
        weight: entry.weight,
        notes: entry.notes || ""
      };
      const { error } = await supabaseClient
        .from("weight_entries")
        .upsert(payload, { onConflict: "user_id,date" });
      if (error) {
        console.error(error);
        throw new Error(error.message);
      }
    }

    async function deleteEntryRemote(entryId) {
      if (!isAuthed()) return;
      const { error } = await supabaseClient
        .from("weight_entries")
        .delete()
        .eq("user_id", supabaseSession.user.id)
        .eq("id", entryId);
      if (error) {
        console.error(error);
        throw new Error(error.message);
      }
    }

    function loadSettingsLocal() {
      return {
        unit: localStorage.getItem(UNIT_KEY) || "kg",
        goal_weight: localStorage.getItem(GOAL_KEY)
          ? JSON.parse(localStorage.getItem(GOAL_KEY)).weight
          : null,
        goal_date: localStorage.getItem(GOAL_KEY)
          ? JSON.parse(localStorage.getItem(GOAL_KEY)).date
          : "",
        full_name: localStorage.getItem("profile_name") || "",
        timezone: localStorage.getItem("profile_tz") || "",
        height_cm: localStorage.getItem("profile_height") || "",
        chart_min: localStorage.getItem("chart_min") || "",
        chart_max: localStorage.getItem("chart_max") || "",
        chart_step: localStorage.getItem("chart_step") || ""
      };
    }

    async function loadSettings() {
      if (isAuthed()) {
        const { data, error } = await supabaseClient
          .from("user_settings")
          .select("unit,goal_weight,goal_date,full_name,timezone,height_cm,chart_min,chart_max,chart_step")
          .eq("user_id", supabaseSession.user.id)
          .maybeSingle();
        if (error) {
          console.error(error);
          return loadSettingsLocal();
        }
        if (!data) return loadSettingsLocal();
        return {
          ...data,
          goal_weight: data.goal_weight !== null ? Number(data.goal_weight) : null,
          height_cm: data.height_cm !== null ? Number(data.height_cm) : null,
          chart_min: data.chart_min !== null ? Number(data.chart_min) : "",
          chart_max: data.chart_max !== null ? Number(data.chart_max) : "",
          chart_step: data.chart_step !== null ? Number(data.chart_step) : ""
        };
      }
      return loadSettingsLocal();
    }

    async function saveSettings(settings) {
      // Always save to localStorage (primary for offline, backup for authed)
      localStorage.setItem(UNIT_KEY, settings.unit || "kg");
      localStorage.setItem(GOAL_KEY, JSON.stringify({
        weight: settings.goal_weight || "",
        date: settings.goal_date || ""
      }));
      localStorage.setItem("profile_name", settings.full_name || "");
      localStorage.setItem("profile_tz", settings.timezone || "");
      localStorage.setItem("profile_height", settings.height_cm || "");
      localStorage.setItem("chart_min", settings.chart_min || "");
      localStorage.setItem("chart_max", settings.chart_max || "");
      localStorage.setItem("chart_step", settings.chart_step || "");

      // Also sync to Supabase if authenticated
      if (isAuthed()) {
        const { error } = await supabaseClient
          .from("user_settings")
          .upsert({
            user_id: supabaseSession.user.id,
            unit: settings.unit,
            goal_weight: settings.goal_weight,
            goal_date: settings.goal_date || null,
            full_name: settings.full_name || null,
            timezone: settings.timezone || null,
            height_cm: settings.height_cm || null,
            chart_min: settings.chart_min || null,
            chart_max: settings.chart_max || null,
            chart_step: settings.chart_step || null
          });
        if (error) {
          console.error(error);
          throw new Error(error.message);
        }
      }
    }

    function setAuthStatus() {
      if (!isSupabaseReady()) {
        authStatusEl.textContent = "Auth: Disabled (set Supabase keys)";
        if (storageStatusEl) storageStatusEl.textContent = "";
        return;
      }
      if (isAuthed()) {
        authStatusEl.textContent = `Auth: ${supabaseSession.user.email}`;
        if (storageStatusEl) storageStatusEl.textContent = "";
      } else {
        authStatusEl.textContent = "Auth: Signed out";
        if (storageStatusEl) storageStatusEl.textContent = "";
      }
    }

    function showAuthMessage(message, isError) {
      if (!authMessageEl) return;
      authMessageEl.textContent = message || "";
      authMessageEl.style.color = isError ? "#b3261e" : "#2e7d32";
    }

    function showSettingsMessage(message, isError) {
      if (!settingsMessageEl) return;
      settingsMessageEl.textContent = message || "";
      settingsMessageEl.style.color = isError ? "#b3261e" : "#2e7d32";
    }

    let entryMessageTimer = null;
    function showEntryMessage(message, isError) {
      if (!entryMessageEl) return;
      if (entryMessageTimer) { clearTimeout(entryMessageTimer); entryMessageTimer = null; }
      entryMessageEl.textContent = message || "";
      entryMessageEl.style.color = isError ? "#b3261e" : "#2e7d32";
      if (message && !isError) {
        entryMessageTimer = setTimeout(() => { entryMessageEl.textContent = ""; }, 2000);
      }
    }

    async function initSupabase() {
      supabaseClient = createSupabaseClient();
      if (!isSupabaseReady()) {
        setAuthStatus();
        return;
      }
      const { data } = await supabaseClient.auth.getSession();
      supabaseSession = data.session;
      setAuthStatus();
      if (supabaseSession) {
        refreshFromAuth();
      }
      supabaseClient.auth.onAuthStateChange((event, session) => {
        supabaseSession = session;
        setAuthStatus();
        refreshFromAuth();
        if (event === "SIGNED_IN") {
          switchPage("entry");
        } else if (event === "SIGNED_OUT") {
          switchPage("login");
        }
      });
    }

    async function refreshFromAuth() {
      const settings = await loadSettings();
      defaultUnitEl.value = settings.unit || "kg";
      syncGoalInputs(settings.goal_weight ? { weight: Number(settings.goal_weight), date: settings.goal_date || "" } : null);
      updateGoalDays();
      profileNameEl.value = settings.full_name || "";
      profileTimezoneEl.value = settings.timezone || "";
      profileHeightEl.value = settings.height_cm ?? "";
      chartMinEl.value = settings.chart_min ?? "";
      chartMaxEl.value = settings.chart_max ?? "";
      chartStepEl.value = settings.chart_step ?? "";
      renderSafe();
    }

    async function signIn() {
      if (!isSupabaseReady()) {
        showAuthMessage("Set Supabase keys first.", true);
        return;
      }
      if (keepSignedInEl) {
        setAuthPersist(keepSignedInEl.checked);
      }
      if (useMagicLinkEl && useMagicLinkEl.checked) {
        await sendMagicLink();
        return;
      }
      const email = loginEmailEl.value.trim();
      const password = loginPassEl.value;
      if (!email) {
        showAuthMessage("Please enter your email.", true);
        return;
      }
      if (!password) {
        showAuthMessage("Please enter your password.", true);
        return;
      }
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        showAuthMessage(error.message, true);
        return;
      }
      showAuthMessage("Signed in.", false);
      await refreshFromAuth();
      switchPage("entry");
    }

    async function signUp() {
      if (!isSupabaseReady()) {
        showAuthMessage("Set Supabase keys first.", true);
        return;
      }
      if (keepSignedInEl) {
        setAuthPersist(keepSignedInEl.checked);
      }
      const email = loginEmailEl.value.trim();
      const password = loginPassEl.value;
      if (!email) {
        showAuthMessage("Please enter your email.", true);
        return;
      }
      if (!password || password.length < 6) {
        showAuthMessage("Please enter a password (at least 6 characters).", true);
        return;
      }
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if (error) {
        showAuthMessage(error.message, true);
        return;
      }
      if (!data.session) {
        showAuthMessage("Account created. Please confirm your email, then sign in.", false);
        return;
      }
      showAuthMessage("Account created. You can sign in now.", false);
      await refreshFromAuth();
      switchPage("entry");
    }

    async function sendMagicLink() {
      if (!isSupabaseReady()) {
        showAuthMessage("Set Supabase keys first.", true);
        return;
      }
      if (keepSignedInEl) {
        setAuthPersist(keepSignedInEl.checked);
      }
      const email = loginEmailEl.value.trim();
      if (!email) {
        showAuthMessage("Please enter your email.", true);
        return;
      }
      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: window.location.href }
      });
      if (error) {
        showAuthMessage(error.message, true);
        return;
      }
      showAuthMessage("Magic link sent. Check your email.", false);
    }

    async function resetPassword() {
      if (!isSupabaseReady()) {
        showAuthMessage("Set Supabase keys first.", true);
        return;
      }
      const email = loginEmailEl.value.trim();
      if (!email) {
        showAuthMessage("Please enter your email.", true);
        return;
      }
      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.href
      });
      if (error) {
        showAuthMessage(error.message, true);
        return;
      }
      showAuthMessage("Password reset email sent.", false);
    }

    async function saveProfileFromInputs() {
      const unit = defaultUnitEl.value || "kg";
      const goalWeight = goalWeightEl.value ? Number(goalWeightEl.value) : null;
      const goalDate = goalDateEl.value || "";
      try {
        await saveSettings({
          unit,
          goal_weight: goalWeight,
          goal_date: goalDate,
          full_name: profileNameEl.value.trim(),
          timezone: profileTimezoneEl.value.trim(),
          height_cm: profileHeightEl.value ? Number(profileHeightEl.value) : null,
          chart_min: chartMinEl.value ? Number(chartMinEl.value) : null,
          chart_max: chartMaxEl.value ? Number(chartMaxEl.value) : null,
          chart_step: chartStepEl.value ? Number(chartStepEl.value) : null
        });
        showSettingsMessage("Settings saved.", false);
        await refreshFromAuth();
        resizeCanvas();
        renderSafe();
        setTimeout(closeSettings, 600);
      } catch (err) {
        showSettingsMessage("Saved locally. Cloud sync failed: " + err.message, true);
      }
    }

    async function signOut() {
      if (!isSupabaseReady()) return;
      await supabaseClient.auth.signOut();
      switchPage("login");
    }

    function sortEntries(entries) {
      return entries.slice().sort((a, b) => b.date.localeCompare(a.date));
    }

    function formatWeight(weight, unit) {
      return `${weight.toFixed(1)} ${unit}`;
    }

    function parseDateISO(value) {
      const date = new Date(value + "T00:00:00");
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function formatDateDisplay(value) {
      const d = parseDateISO(value);
      if (!d) return value;
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    function daysBetween(a, b) {
      const ms = b.getTime() - a.getTime();
      return Math.round(ms / 86400000);
    }

    function renderTable(entries, unit) {
      tableBody.innerHTML = "";
      for (const entry of entries) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatDateDisplay(entry.date)}</td>
          <td>${formatWeight(entry.weight, unit)}</td>
          <td class="actions">
            <button data-action="edit" data-id="${entry.id}" class="secondary">Edit</button>
          </td>
        `;
        tableBody.appendChild(tr);
      }
    }

    function renderStats(entries, goal, unit) {
      if (entries.length === 0) {
        statsEl.innerHTML = "<div class=\"stat\"><div class=\"label\">No data yet</div><div class=\"value\">Add an entry</div></div>";
        return;
      }

      const sorted = entries.slice().sort((a, b) => a.date.localeCompare(b.date));
      const first = sorted[0];
      const latest = sorted[sorted.length - 1];

      const lastSeven = sorted.slice(-7);
      const avg7 = lastSeven.reduce((sum, e) => sum + e.weight, 0) / lastSeven.length;
      const change = latest.weight - first.weight;

      const stats = [
        { label: "Latest", value: formatWeight(latest.weight, unit) },
        { label: "7-day avg", value: formatWeight(avg7, unit) },
        { label: "Change since start", value: `${change >= 0 ? "+" : ""}${change.toFixed(1)} ${unit}` }
      ];

      if (goal) {
        const goalWeight = goal.weight;
        const deltaTotal = goalWeight - first.weight;
        const deltaDone = latest.weight - first.weight;
        const progress = deltaTotal === 0 ? 1 : Math.min(1, Math.max(0, deltaDone / deltaTotal));

        const goalDate = parseDateISO(goal.date);
        let paceText = "";
        if (goalDate) {
          const latestDate = parseDateISO(latest.date) || new Date();
          const remainingDays = daysBetween(latestDate, goalDate);
          if (remainingDays > 0) {
            const remaining = goalWeight - latest.weight;
            const perWeek = remaining / (remainingDays / 7);
            paceText = `${perWeek >= 0 ? "+" : ""}${perWeek.toFixed(1)} ${unit}/week`;
          } else {
            paceText = "Goal date passed";
          }
        }

        stats.push(
          { label: "Goal", value: formatWeight(goalWeight, unit) },
          { label: "Progress", value: `${Math.round(progress * 100)}%` },
          { label: "Required pace", value: paceText || "Set a goal date" }
        );
      }

      statsEl.innerHTML = "";
      for (const s of stats) {
        const div = document.createElement("div");
        div.className = "stat";
        div.innerHTML = `<div class="label">${s.label}</div><div class="value">${s.value}</div>`;
        statsEl.appendChild(div);
      }
    }

    function resizeCanvas() {
      const rect = chart.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      chart.width = rect.width * dpr;
      chart.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function computeAvgSeries(values) {
      const avg = [];
      for (let i = 0; i < values.length; i++) {
        const start = Math.max(0, i - 6);
        const slice = values.slice(start, i + 1);
        const a = slice.reduce((sum, v) => sum + v, 0) / slice.length;
        avg.push(a);
      }
      return avg;
    }

    function drawChart(entries, unit, settings) {
      const rect = chart.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      ctx.clearRect(0, 0, width, height);

      if (entries.length < 1) {
        ctx.fillStyle = "#7a6d5f";
        ctx.font = "14px Space Grotesk, Fira Sans, sans-serif";
        ctx.fillText("Add an entry to see the chart.", 16, 28);
        return;
      }

      let sorted = entries.slice().sort((a, b) => a.date.localeCompare(b.date));

      // Apply date range filter
      if (chartDateFrom) sorted = sorted.filter(e => e.date >= chartDateFrom);
      if (chartDateTo) sorted = sorted.filter(e => e.date <= chartDateTo);

      const points = sorted.map(e => {
        const date = parseDateISO(e.date);
        return { date, dateStr: e.date, value: e.weight };
      }).filter(p => p.date);

      if (points.length < 1) {
        ctx.fillStyle = "#7a6d5f";
        ctx.font = "14px Space Grotesk, Fira Sans, sans-serif";
        ctx.fillText("No entries in this date range.", 16, 28);
        return;
      }

      const padLeft = 56;
      const padRight = 16;
      const padTop = 20;
      const padBottom = 44;
      const xStep = points.length > 1 ? (width - padLeft - padRight) / (points.length - 1) : 0;

      const values = points.map(p => p.value);
      const avgValues = computeAvgSeries(values);
      let minVal = Math.min(...values, ...avgValues);
      let maxVal = Math.max(...values, ...avgValues);
      if (settings?.chart_min !== "" && settings?.chart_min !== null) {
        minVal = Number(settings.chart_min);
      }
      if (settings?.chart_max !== "" && settings?.chart_max !== null) {
        maxVal = Number(settings.chart_max);
      }
      // Round to nearest 0.5 for cleaner axis
      minVal = Math.floor(minVal * 2) / 2;
      maxVal = Math.ceil(maxVal * 2) / 2;
      if (maxVal <= minVal) maxVal = minVal + 1;
      const valSpan = maxVal - minVal || 1;

      function xForIndex(i) { return padLeft + i * xStep; }
      function yFor(value) { return padTop + ((maxVal - value) / valSpan) * (height - padTop - padBottom); }

      // Dynamic grid and label intervals based on available space
      const chartHeight = height - padTop - padBottom;
      const minGridPx = 8;
      const maxGridLines = Math.floor(chartHeight / minGridPx);
      let gridStep = 0.25;
      if (valSpan / gridStep > maxGridLines) gridStep = 0.5;
      if (valSpan / gridStep > maxGridLines) gridStep = 1;
      if (valSpan / gridStep > maxGridLines) gridStep = 2;
      if (valSpan / gridStep > maxGridLines) gridStep = Math.ceil(valSpan / maxGridLines);

      const minLabelPx = 20;
      const maxLabels = Math.floor(chartHeight / minLabelPx);
      let labelStep = 0.5;
      if (valSpan / labelStep > maxLabels) labelStep = 1;
      if (valSpan / labelStep > maxLabels) labelStep = 2;
      if (valSpan / labelStep > maxLabels) labelStep = 5;
      if (valSpan / labelStep > maxLabels) labelStep = 10;
      if (valSpan / labelStep > maxLabels) labelStep = Math.ceil(valSpan / maxLabels);

      const firstTick = Math.ceil(minVal / gridStep) * gridStep;
      ctx.font = "10px Space Grotesk, Fira Sans, sans-serif";
      ctx.textAlign = "right";
      for (let v = firstTick; v <= maxVal + 0.001; v += gridStep) {
        const y = yFor(v);
        const isWhole = Math.abs(v - Math.round(v)) < 0.01;
        const isHalf = Math.abs((v * 2) - Math.round(v * 2)) < 0.01;
        if (isWhole) {
          ctx.strokeStyle = "rgba(100,80,60,0.25)";
          ctx.lineWidth = 1;
        } else if (isHalf) {
          ctx.strokeStyle = "rgba(100,80,60,0.15)";
          ctx.lineWidth = 0.75;
        } else {
          ctx.strokeStyle = "rgba(100,80,60,0.07)";
          ctx.lineWidth = 0.5;
        }
        ctx.beginPath();
        ctx.moveTo(padLeft, y);
        ctx.lineTo(width - padRight, y);
        ctx.stroke();
        // Label at dynamic intervals
        const onLabel = Math.abs(v / labelStep - Math.round(v / labelStep)) < 0.01;
        if (onLabel) {
          ctx.fillStyle = "#8a7f70";
          ctx.fillText(v.toFixed(1), padLeft - 8, y + 3);
        }
      }
      ctx.textAlign = "start";

      // Bars
      const barWidth = Math.max(6, Math.min(22, (width - padLeft - padRight) / Math.max(1, points.length) * 0.6));
      const barGradient = ctx.createLinearGradient(0, padTop, 0, height - padBottom);
      barGradient.addColorStop(0, "rgba(45,123,255,0.85)");
      barGradient.addColorStop(1, "rgba(255,94,168,0.55)");

      points.forEach((p, i) => {
        const x = xForIndex(i);
        const y = yFor(p.value);
        const rawH = height - padBottom - y;
        const h = Math.max(2, rawH);
        const yTop = rawH < 2 ? y - (2 - rawH) : y;
        ctx.fillStyle = barGradient;
        ctx.fillRect(x - barWidth / 2, yTop, barWidth, h);
      });

      // 7-day average line
      ctx.strokeStyle = "#7b4dff";
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      avgValues.forEach((v, i) => {
        const x = xForIndex(i);
        const y = yFor(v);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // X axis date labels
      ctx.fillStyle = "#8a7f70";
      ctx.font = "10px Space Grotesk, Fira Sans, sans-serif";
      ctx.textAlign = "center";
      const maxLabels = Math.floor((width - padLeft - padRight) / 52);
      const labelEvery = Math.max(1, Math.ceil(points.length / maxLabels));
      points.forEach((p, i) => {
        if (i % labelEvery !== 0 && i !== points.length - 1) return;
        const x = xForIndex(i);
        const dd = String(p.date.getDate()).padStart(2, "0");
        const mm = String(p.date.getMonth() + 1).padStart(2, "0");
        ctx.fillText(`${dd}/${mm}`, x, height - padBottom + 16);
      });
      ctx.textAlign = "start";

      // Goal line
      if (settings?.goal_weight) {
        const goalVal = Number(settings.goal_weight);
        const goalY = yFor(goalVal);
        if (goalY >= padTop && goalY <= height - padBottom) {
          ctx.strokeStyle = "rgba(255,94,168,0.6)";
          ctx.lineWidth = 1.5;
          ctx.setLineDash([6, 4]);
          ctx.beginPath();
          ctx.moveTo(padLeft, goalY);
          ctx.lineTo(width - padRight, goalY);
          ctx.stroke();
          ctx.setLineDash([]);
          ctx.fillStyle = "rgba(255,94,168,0.8)";
          ctx.textAlign = "right";
          ctx.font = "10px Space Grotesk, Fira Sans, sans-serif";
          ctx.fillText(`Goal: ${goalVal.toFixed(1)}`, width - padRight, goalY - 4);
          ctx.textAlign = "start";
        }
      }
    }

    async function render() {
      const unit = defaultUnitEl.value || "kg";
      const entries = sortEntries(await loadEntries());
      const settings = await loadSettings();
      const goal = settings.goal_weight ? { weight: Number(settings.goal_weight), date: settings.goal_date || "" } : null;
      renderTable(entries, unit);
      renderStats(entries, goal, unit);
      drawChart(entries, unit, settings);
    }

    function renderSafe() {
      render().catch(err => console.error(err));
    }

    function clearForm() {
      weightEl.value = "";
      notesEl.value = "";
      dateEl.value = todayISO();
      editingId = null;
      deleteBtn.style.display = "none";
    }

    async function addEntry() {
      const date = dateEl.value || todayISO();
      const weight = parseFloat(weightEl.value);
      if (!date || Number.isNaN(weight) || weight <= 0) {
        showEntryMessage("Please enter a date and valid weight.", true);
        return;
      }

      try {
        const entries = await loadEntries();
        const existingByDate = entries.find(e => e.date === date);
        if (editingId) {
          const current = entries.find(e => e.id === editingId);
          if (!current) {
            editingId = null;
          } else {
            if (existingByDate && existingByDate.id !== editingId) {
              if (!confirm("Another entry exists for that date. Replace it?")) return;
              const filtered = entries.filter(e => e.id !== existingByDate.id);
              const target = filtered.find(e => e.id === editingId);
              if (target) {
                target.date = date;
                target.weight = weight;
                target.notes = notesEl.value.trim();
              }
              saveEntriesLocal(filtered);
              if (isAuthed()) {
                await deleteEntryRemote(existingByDate.id);
                await saveEntryRemote(target);
              }
              showEntryMessage("Entry saved.", false);
              renderSafe();
              clearForm();
              return;
            }
            current.date = date;
            current.weight = weight;
            current.notes = notesEl.value.trim();
            saveEntriesLocal(entries);
            if (isAuthed()) {
              await saveEntryRemote(current);
            }
            showEntryMessage("Entry saved.", false);
            renderSafe();
            clearForm();
            return;
          }
        }

        if (existingByDate) {
          if (!confirm("An entry exists for that date. Replace it?")) return;
          existingByDate.weight = weight;
          existingByDate.notes = notesEl.value.trim();
        } else {
          entries.push({
            id: crypto.randomUUID(),
            date,
            weight,
            notes: notesEl.value.trim()
          });
        }

        saveEntriesLocal(entries);
        if (isAuthed()) {
          const target = existingByDate || entries[entries.length - 1];
          await saveEntryRemote(target);
        }
        showEntryMessage("Entry saved.", false);
        renderSafe();
        clearForm();
      } catch (err) {
        showEntryMessage("Save failed: " + err.message, true);
      }
    }

    async function handleTableClick(e) {
      const button = e.target.closest("button");
      if (!button) return;
      const id = button.getAttribute("data-id");
      const action = button.getAttribute("data-action");
      const entries = await loadEntries();
      const entry = entries.find(x => x.id === id);
      if (!entry) return;

      if (action === "edit") {
        switchPage("entry");
        dateEl.value = entry.date;
        weightEl.value = entry.weight;
        notesEl.value = entry.notes || "";
        editingId = entry.id;
        deleteBtn.style.display = "inline-block";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    }

    async function deleteEntry() {
      if (!editingId) return;
      if (!confirm("Delete this entry?")) return;
      try {
        const entries = (await loadEntries()).filter(e => e.id !== editingId);
        saveEntriesLocal(entries);
        if (isAuthed()) {
          await deleteEntryRemote(editingId);
        }
        showEntryMessage("Entry deleted.", false);
        renderSafe();
        clearForm();
      } catch (err) {
        showEntryMessage("Delete failed: " + err.message, true);
      }
    }


    function syncGoalInputs(goal) {
      if (!goal) {
        goalWeightEl.value = "";
        goalDateEl.value = "";
        goalWeeksEl.value = "";
        if (goalDaysEl) goalDaysEl.textContent = "0 days";
        return;
      }
      goalWeightEl.value = goal.weight;
      goalDateEl.value = goal.date || "";
      if (goal.date) {
        const weeks = Math.max(1, Math.round(daysBetween(new Date(), parseDateISO(goal.date)) / 7));
        goalWeeksEl.value = weeks;
      }
      updateGoalDays();
    }

    function updateGoalDateFromWeeks() {
      const weeks = parseInt(goalWeeksEl.value, 10);
      if (!weeks || weeks < 1) return;
      const start = new Date();
      start.setDate(start.getDate() + weeks * 7);
      const local = new Date(start.getTime() - start.getTimezoneOffset() * 60000);
      goalDateEl.value = local.toISOString().slice(0, 10);
      updateGoalDays();
    }

    function updateWeeksFromGoalDate() {
      if (!goalDateEl.value) return;
      const goalDate = parseDateISO(goalDateEl.value);
      if (!goalDate) return;
      const weeks = Math.max(1, Math.round(daysBetween(new Date(), goalDate) / 7));
      goalWeeksEl.value = weeks;
      updateGoalDays();
    }

    function updateGoalDays() {
      if (!goalDaysEl) return;
      let days = 0;
      if (goalDateEl.value) {
        const goalDate = parseDateISO(goalDateEl.value);
        if (goalDate) {
          days = Math.max(0, daysBetween(new Date(), goalDate));
        }
      } else if (goalWeeksEl.value) {
        const weeks = parseInt(goalWeeksEl.value, 10);
        if (weeks && weeks > 0) days = weeks * 7;
      }
      goalDaysEl.textContent = `${days} days`;
    }

    function handleUnitChange() {
      renderSafe();
    }

    async function openSettings() {
      showSettingsMessage("");
      settingsBackdrop.classList.add("open");
      settingsBackdrop.setAttribute("aria-hidden", "false");
      await refreshFromAuth();
    }

    function closeSettings() {
      settingsBackdrop.classList.remove("open");
      settingsBackdrop.setAttribute("aria-hidden", "true");
    }

    function switchPage(page) {
      pages.forEach(p => p.classList.toggle("active", p.id === `page-${page}`));
      navButtons.forEach(b => b.classList.toggle("active", b.dataset.page === page));
      const shell = document.querySelector(".device-shell");
      shell.classList.toggle("login-mode", page === "login");
      shell.classList.toggle("entry-mode", page === "entry");
      if (page === "chart") {
        resizeCanvas();
        renderSafe();
      }
    }

    window.addEventListener("resize", () => {
      resizeCanvas();
      renderSafe();
    });

    document.getElementById("saveBtn").addEventListener("click", addEntry);
    document.getElementById("clearBtn").addEventListener("click", clearForm);
    deleteBtn.addEventListener("click", deleteEntry);

    goalWeeksEl.addEventListener("change", updateGoalDateFromWeeks);
    goalDateEl.addEventListener("change", updateWeeksFromGoalDate);

    chartRangeBtn.addEventListener("click", () => {
      chartDateFrom = chartFromEl.value || "";
      chartDateTo = chartToEl.value || "";
      resizeCanvas();
      renderSafe();
    });
    chartResetBtn.addEventListener("click", () => {
      chartDateFrom = "";
      chartDateTo = "";
      chartFromEl.value = "";
      chartToEl.value = "";
      resizeCanvas();
      renderSafe();
    });

    tableBody.addEventListener("click", handleTableClick);
    defaultUnitEl.addEventListener("change", handleUnitChange);
    closeSettingsBtn.addEventListener("click", closeSettings);
    settingsBackdrop.addEventListener("click", (e) => {
      if (e.target === settingsBackdrop) closeSettings();
    });

    navButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const page = btn.dataset.page;
        if (page === "settings") {
          openSettings();
          return;
        }
        switchPage(page);
      });
    });

    loginBtn.addEventListener("click", signIn);
    signupBtn.addEventListener("click", signUp);
    magicLinkBtn.addEventListener("click", sendMagicLink);
    resetPassBtn.addEventListener("click", resetPassword);
    useMagicLinkEl.addEventListener("change", () => {
      passwordFieldEl.style.display = useMagicLinkEl.checked ? "none" : "";
    });
    signOutBtn.addEventListener("click", signOut);
    saveSettingsBtn.addEventListener("click", saveProfileFromInputs);

    async function initApp() {
      dateEl.value = todayISO();
      await initSupabase();
      const settings = await loadSettings();
      defaultUnitEl.value = settings.unit || "kg";
      syncGoalInputs(settings.goal_weight ? { weight: Number(settings.goal_weight), date: settings.goal_date || "" } : null);
      updateGoalDays();
      resizeCanvas();
      renderSafe();
      setTimeout(() => {
        if (splashEl) splashEl.classList.add("hidden");
      }, 400);

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(() => {});
      }
    }

    initApp().catch(err => console.error(err));
  </script>
</body>
</html>
